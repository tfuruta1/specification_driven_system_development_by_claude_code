# /security - セキュリティ設計・監査コマンド

## 目的
o3 MCPのセキュリティスペシャリストとして、セキュリティツールとの直接連携能力を活用し、セキュリティ設計・脅威分析・監査・インシデント対応を実行します。

## 対象AI
- **o3 MCP**: セキュリティツール連携、リアルタイム脅威検知、システムレベルセキュリティ分析能力を活用

## 入力パラメータ
- **必須**: `$SECURITY_TYPE` - セキュリティタイプ（threat_analysis, security_audit, compliance, incident_response, penetration_test）
- **任意**: `$SECURITY_SCOPE` - セキュリティ範囲（application, infrastructure, data, network, endpoint）
- **任意**: `$COMPLIANCE_STANDARD` - コンプライアンス基準（gdpr, hipaa, sox, iso27001, pci_dss）
- **任意**: `$THREAT_LEVEL` - 脅威レベル（low, medium, high, critical）

## 出力
- **セキュリティ評価書**: `.tmp/security_assessment_[timestamp].md`
- **脅威分析レポート**: `.tmp/threat_analysis.md`
- **セキュリティ設計書**: `.tmp/security_design.md`
- **対策実装ガイド**: `.tmp/security_implementation.md`
- **インシデント対応計画**: `.tmp/incident_response_plan.md`

## ワークフロー

### Phase 1: セキュリティ分析・評価
```markdown
## セキュリティ分析フェーズ

### 1. 資産・攻撃面分析
- システム資産・データ資産の特定
- 攻撃面・エントリーポイントの分析
- 外部依存・サードパーティリスク
- ユーザー・権限・アクセスパターン分析

### 2. 脅威モデリング
- STRIDE脅威分析フレームワーク
- 攻撃シナリオ・攻撃ツリー作成
- 脅威アクター・動機・能力分析
- 脅威インテリジェンス・最新動向調査

### 3. 脆弱性評価
- 技術的脆弱性スキャン・評価
- 設定・運用脆弱性分析
- コード・設計脆弱性レビュー
- サプライチェーン・依存関係脆弱性

### 4. リスク評価・優先順位付け
- 脅威発生確率・影響度評価
- ビジネスインパクト・損失見積もり
- リスクマトリクス・優先順位付け
- 受容可能リスクレベル設定
```

### Phase 2: セキュリティ設計・対策
```markdown
## セキュリティ設計フェーズ

### 1. セキュリティアーキテクチャ設計
- 多層防御・Defense in Depth戦略
- ゼロトラスト・セキュリティモデル
- セキュリティ境界・セグメンテーション
- 暗号化・データ保護戦略

### 2. アクセス制御・認証設計
- 認証・認可メカニズム設計
- 最小権限・職務分離原則
- 特権アクセス管理（PAM）
- アイデンティティ・ライフサイクル管理

### 3. 監視・検知システム設計
- セキュリティ監視・SIEM設計
- 侵入検知・防御システム（IDS/IPS）
- ログ管理・フォレンジック対応
- 脅威ハンティング・分析基盤

### 4. インシデント対応・復旧設計
- インシデント対応計画・手順
- エスカレーション・通知体制
- フォレンジック・証拠保全
- 事業継続・災害復旧計画
```

### Phase 3: 実装・運用・改善
```markdown
## 実装・運用フェーズ

### 1. セキュリティ対策実装
- 技術的セキュリティ対策導入
- セキュリティツール・サービス統合
- セキュリティ設定・ハードニング
- セキュリティテスト・検証

### 2. セキュリティ運用・監視
- 24/7セキュリティ監視体制
- セキュリティイベント・アラート管理
- 脅威インテリジェンス・情報収集
- 定期的セキュリティ評価・監査

### 3. インシデント対応・学習
- セキュリティインシデント対応
- 根本原因分析・改善策実装
- レッスンラーンド・知識共有
- セキュリティ意識向上・教育

### 4. 継続的改善・進化
- 脅威環境・技術動向追跡
- セキュリティ対策・プロセス改善
- 新技術・新脅威への対応
- セキュリティ成熟度向上
```

## セキュリティタイプ別仕様

### 1. 脅威分析（threat_analysis）
```yaml
目的: システム・データに対する脅威の特定・分析・評価
成果物:
  - 脅威モデル・攻撃シナリオ
  - リスク評価・優先順位マトリクス
  - 対策推奨事項・実装計画
  - 脅威インテリジェンスレポート
分析手法:
  - STRIDE・PASTA・TARA脅威モデリング
  - 攻撃ツリー・キルチェーン分析
  - 脅威アクター・TTP分析
  - 脆弱性・エクスプロイト調査
```

### 2. セキュリティ監査（security_audit）
```yaml
目的: セキュリティ統制・対策の有効性評価・改善提案
成果物:
  - セキュリティ監査レポート
  - 統制不備・改善提案
  - コンプライアンス適合性評価
  - セキュリティ成熟度評価
監査領域:
  - アクセス制御・認証認可
  - データ保護・暗号化
  - システム・ネットワークセキュリティ
  - セキュリティ運用・インシデント対応
```

### 3. コンプライアンス（compliance）
```yaml
目的: 法規制・業界標準・セキュリティフレームワークへの適合
成果物:
  - コンプライアンス評価レポート
  - ギャップ分析・改善計画
  - 証拠・ドキュメント整備
  - 監査対応・報告書作成
対象基準:
  - GDPR・個人情報保護法
  - ISO 27001・NIST Framework
  - PCI DSS・HIPAA・SOX法
  - 業界固有基準・ガイドライン
```

### 4. インシデント対応（incident_response）
```yaml
目的: セキュリティインシデントの検知・対応・復旧・改善
成果物:
  - インシデント対応計画・手順書
  - エスカレーション・通知体制
  - フォレンジック・調査手順
  - 事後分析・改善提案
対応フェーズ:
  - 準備・計画（Preparation）
  - 特定・検知（Identification）
  - 封じ込め・除去・復旧（Containment・Eradication・Recovery）
  - 事後分析・学習（Lessons Learned）
```

### 5. ペネトレーションテスト（penetration_test）
```yaml
目的: 実際の攻撃シミュレーションによる脆弱性検証
成果物:
  - ペネトレーションテストレポート
  - 脆弱性・エクスプロイト詳細
  - リスク評価・対策推奨
  - 検証・再テスト結果
テスト種別:
  - ブラックボックス・ホワイトボックス・グレーボックス
  - 外部・内部・ワイヤレス・Webアプリケーション
  - ソーシャルエンジニアリング・物理セキュリティ
  - Red Team・Blue Team演習
```

## 成果物テンプレート

### セキュリティ評価書構成
```markdown
# セキュリティ評価書

## エグゼクティブサマリー
- 評価概要・対象範囲
- 主要発見事項・リスクレベル
- 推奨対策・優先順位
- 投資・実装スケジュール

## 評価対象・スコープ
### システム・アプリケーション
- 対象システム・コンポーネント
- データフロー・統合ポイント
- ユーザー・権限・アクセスパターン
- 技術スタック・プラットフォーム

### 評価基準・手法
- 適用セキュリティ標準・フレームワーク
- 評価手法・ツール・技術
- テスト・検証方法
- 評価期間・制約条件

## 脅威・リスク分析
### 脅威モデル
```
[脅威モデル図 - 攻撃者・攻撃手法・対象資産]

主要脅威シナリオ:
1. 外部攻撃者によるWebアプリケーション侵入
   - 攻撃手法: SQLインジェクション・XSS・認証回避
   - 対象資産: ユーザーデータ・機密情報
   - 影響: データ漏洩・サービス停止・信頼失墜

2. 内部関係者による権限濫用
   - 攻撃手法: 特権アクセス悪用・データ持ち出し
   - 対象資産: 顧客データ・営業秘密
   - 影響: 内部情報漏洩・コンプライアンス違反
```

### リスク評価マトリクス
| 脅威 | 発生確率 | 影響度 | リスクレベル | 優先度 |
|------|----------|--------|-------------|--------|
| SQLインジェクション | 高 | 高 | 重大 | 1 |
| 認証回避 | 中 | 高 | 高 | 2 |
| クロスサイトスクリプティング | 高 | 中 | 高 | 3 |
| 権限昇格 | 低 | 高 | 中 | 4 |
| サービス拒否攻撃 | 中 | 中 | 中 | 5 |

## 脆弱性・発見事項
### 重大な脆弱性
#### 1. SQLインジェクション脆弱性
- **場所**: ユーザー検索機能（/api/users/search）
- **詳細**: パラメータ化クエリ未使用・入力検証不備
- **影響**: データベース全体への不正アクセス・データ改竄
- **CVSS**: 9.8 (Critical)
- **対策**: パラメータ化クエリ実装・入力検証強化・WAF導入

#### 2. 認証回避脆弱性
- **場所**: 管理者ログイン機能（/admin/login）
- **詳細**: JWT署名検証不備・セッション管理脆弱性
- **影響**: 管理者権限への不正昇格・システム全体制御
- **CVSS**: 9.1 (Critical)
- **対策**: JWT署名検証修正・セッション管理強化・MFA導入

### 高リスクな脆弱性
[同様の構成で中・低リスク脆弱性を記載]

## 対策推奨事項
### 即座に実施すべき対策（Critical - 1週間以内）
1. **SQLインジェクション対策**
   - 実装: パラメータ化クエリ・ORMフレームワーク活用
   - 期間: 3-5日
   - 工数: 2-3人日
   - 優先度: 最高

2. **認証強化**
   - 実装: JWT署名検証・セッション管理改修
   - 期間: 5-7日  
   - 工数: 3-4人日
   - 優先度: 最高

### 短期対策（High - 1ヶ月以内）
1. **Web Application Firewall（WAF）導入**
2. **セキュリティヘッダー実装**
3. **ログ・監視強化**
4. **セキュリティテスト自動化**

### 中長期対策（Medium - 3ヶ月以内）
1. **ゼロトラストアーキテクチャ移行**
2. **暗号化・データ保護強化**  
3. **セキュリティ意識向上・教育**
4. **インシデント対応体制強化**

## 実装計画・ロードマップ
### Phase 1: 緊急対応（1-2週間）
- 重大脆弱性の修正・パッチ適用
- 緊急監視・アラート設定
- 一時的回避策・制限実装

### Phase 2: セキュリティ基盤強化（1-2ヶ月）
- WAF・セキュリティツール導入
- セキュリティ監視・SIEM構築
- 認証・アクセス制御強化

### Phase 3: 継続的セキュリティ（3-6ヶ月）
- セキュリティ開発ライフサイクル統合
- 定期的セキュリティテスト・監査
- セキュリティ文化・意識醸成

## コンプライアンス・規制対応
### GDPR対応状況
- **個人データ保護**: 暗号化・アクセス制御実装済み
- **データポータビリティ**: API実装・データエクスポート機能
- **忘れられる権利**: データ削除機能実装・履歴管理
- **データ保護影響評価**: 実施済み・定期レビュー計画

### セキュリティ監査・認証
- **ISO 27001**: 2024年Q2取得予定・ギャップ分析完了
- **SOC 2**: Type I実施済み・Type II計画中
- **内部監査**: 四半期実施・改善サイクル運用

## 測定・モニタリング
### セキュリティKPI・メトリクス
- **脆弱性管理**: 検出後30日以内修正率 > 95%
- **インシデント対応**: 平均対応時間 < 4時間
- **セキュリティ監視**: 検知精度 > 90%・誤検知率 < 5%
- **教育・意識**: セキュリティ教育受講率 > 95%

### 継続的改善・レビュー
- 月次セキュリティレビュー・指標評価
- 四半期脅威分析・リスク評価更新
- 年次セキュリティ監査・第三者評価
- セキュリティインシデント事後分析・改善
```

### インシデント対応計画テンプレート
```markdown
# セキュリティインシデント対応計画

## 対応体制・役割分担
### インシデント対応チーム（CSIRT）
- **インシデント管理者**: 全体統括・意思決定・外部連絡
- **技術分析担当**: 技術調査・フォレンジック・対策実装
- **コミュニケーション担当**: 内外コミュニケーション・広報対応
- **法務・コンプライアンス**: 法的対応・規制報告・契約対応

### エスカレーション・連絡体制
```
Level 1: セキュリティ担当者
↓ (重要度: Medium以上)
Level 2: セキュリティマネージャー・システム管理者
↓ (重要度: High以上)
Level 3: CISO・IT部長・事業部長
↓ (重要度: Critical)
Level 4: CEO・取締役会・外部専門家

緊急連絡先:
- セキュリティ担当: [電話・メール・Slack]
- システム管理者: [電話・メール・Slack]
- 外部セキュリティベンダー: [電話・メール]
```

## インシデント分類・優先度
### 重要度レベル
#### Critical（重大）
- **定義**: 重要システム停止・大規模データ漏洩・攻撃進行中
- **対応時間**: 即座（15分以内）
- **対応体制**: 全チームメンバー・外部専門家
- **報告**: CEO・取締役会・規制当局

#### High（高）  
- **定義**: システム機能影響・限定的データ漏洩・攻撃の兆候
- **対応時間**: 1時間以内
- **対応体制**: コアチームメンバー
- **報告**: CISO・事業部長

#### Medium（中）
- **定義**: 軽微な機能影響・セキュリティ警告・疑わしい活動
- **対応時間**: 4時間以内
- **対応体制**: セキュリティ担当・システム管理者
- **報告**: セキュリティマネージャー

#### Low（低）
- **定義**: 軽微な異常・潜在的脅威・予防的対応
- **対応時間**: 1営業日以内
- **対応体制**: セキュリティ担当
- **報告**: 定期レポート

## インシデント対応プロセス
### Phase 1: 準備（Preparation）
#### 事前準備・計画
- [ ] インシデント対応計画・手順書整備
- [ ] 対応チーム・役割分担・連絡体制確立
- [ ] ツール・システム・リソース準備
- [ ] 定期訓練・教育・意識向上

#### 監視・検知体制
- [ ] セキュリティ監視・SIEM運用
- [ ] ログ・アラート・通知設定
- [ ] 脅威インテリジェンス・情報収集
- [ ] 脆弱性管理・パッチ適用

### Phase 2: 検知・特定（Identification）
#### 初期対応（15分以内）
1. **アラート・報告受信**
   - [ ] セキュリティアラート・通知確認
   - [ ] ユーザー・システム管理者からの報告
   - [ ] 外部機関・ベンダーからの通知

2. **初期分析・トリアージ**
   - [ ] インシデント真偽・重要度判定
   - [ ] 影響範囲・被害状況の概算
   - [ ] 対応チーム・リソース召集

3. **記録・証拠保全開始**
   - [ ] インシデント記録・タイムライン作成
   - [ ] ログ・証拠データ保全・バックアップ
   - [ ] 関係者・ステークホルダー通知

### Phase 3: 封じ込め（Containment）
#### 短期封じ込め（1時間以内）
- [ ] 攻撃・侵入の即座停止・隔離
- [ ] 影響システム・ネットワークセグメント分離
- [ ] 不正アクセス・アカウント無効化
- [ ] 緊急パッチ・設定変更適用

#### 長期封じ込め（24時間以内）
- [ ] 根本原因・攻撃経路の特定・遮断
- [ ] システム・データ整合性検証
- [ ] バックアップ・復旧準備
- [ ] セキュリティ対策・監視強化

### Phase 4: 除去・復旧（Eradication & Recovery）
#### 脅威除去・システム修復
- [ ] マルウェア・攻撃ツール除去
- [ ] 脆弱性・設定不備修正
- [ ] システム・データ復旧・検証
- [ ] セキュリティ対策・監視強化

#### 段階的復旧・検証
- [ ] テスト環境での動作確認
- [ ] 段階的サービス復旧・監視強化
- [ ] ユーザー・ステークホルダー通知
- [ ] 正常運用復帰・継続監視

### Phase 5: 事後分析・改善（Lessons Learned）
#### 根本原因分析・報告
- [ ] インシデント詳細分析・タイムライン作成
- [ ] 根本原因・攻撃手法・影響範囲特定
- [ ] 対応プロセス・判断・結果評価
- [ ] ステークホルダー・規制当局報告

#### 改善・再発防止策
- [ ] セキュリティ対策・プロセス改善
- [ ] システム・設定・運用見直し
- [ ] 教育・訓練・意識向上計画
- [ ] インシデント対応計画・手順更新

## 外部連携・報告
### 規制当局・法執行機関
- **個人情報保護委員会**: データ漏洩・個人情報関連
- **サイバー犯罪対策課**: 刑事事件・証拠保全
- **JPCERT/CC**: インシデント情報共有・技術支援

### 外部専門機関・ベンダー
- **セキュリティベンダー**: 緊急対応・フォレンジック
- **法律事務所**: 法的対応・損害賠償・契約
- **PR・危機管理会社**: 広報対応・レピュテーション管理

### 顧客・パートナー・メディア
- **顧客通知**: 影響・対策・今後の対応
- **パートナー企業**: 連携システム・データ影響
- **メディア対応**: プレスリリース・記者会見
```

## 連携コマンド
- **← /architecture**: アーキテクチャ設計のセキュリティ要件反映
- **← /devops**: DevOps・運用プロセスのセキュリティ統合
- **→ /analyze**: セキュリティログ・インシデントデータ分析
- **→ /fix**: セキュリティ脆弱性・インシデントの修復

## 品質チェックリスト
- [ ] 脅威・リスク分析の妥当性・網羅性確認
- [ ] セキュリティ対策の有効性・実装可能性評価
- [ ] コンプライアンス・規制要件の適合性確認
- [ ] インシデント対応体制・手順の実効性検証
- [ ] 継続的監視・改善プロセスの実装可能性確認

## 使用例

### 脅威分析・リスク評価
```bash
/security threat_analysis --security_scope="application" --threat_level="high"
```

### セキュリティ監査・評価
```bash
/security security_audit --security_scope="infrastructure" --compliance_standard="iso27001"
```

### インシデント対応計画
```bash
/security incident_response --security_scope="all" --threat_level="critical"
```